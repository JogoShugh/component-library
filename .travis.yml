language: node_js

sudo: required

cache:
  yarn: true
  directories:
    - ~/.cache
  override:
    - yarn install --frozen-lockfile

defaults: &deploySite
  install:
    - ./scripts/bin/docker-install.sh
  script:
    - ./scripts/bin/docker-publish-docs.sh

defaults: &test
  install:
    - ./scripts/bin/docker-install.sh
  env:
    - NODE_ENV=test
    - STAGE_NAME=4x-electron
    - SHA=$TRAVIS_COMMIT
  script:
    - ./scripts/bin/docker-test.sh

jobs:
  include:
    - stage: Verify
      install:
        - ./scripts/bin/docker-install.sh
      script:
        - ./scripts/bin/docker-lint.sh

    - stage: Verify
      if: type = push
      install:
        - ./scripts/bin/docker-install.sh
      env:
        - NODE_ENV=test
        - STAGE_NAME=4x-electron
        - SHA=$TRAVIS_COMMIT
      script:
        - ./scripts/bin/docker-test.sh

    - stage: Verify
      if: type = pull_request
      install:
        - ./scripts/bin/docker-install.sh
      env:
        - NODE_ENV=test
        - STAGE_NAME=4x-electron
        - SHA=$TRAVIS_PULL_REQUEST_SHA
      script:
        - ./scripts/bin/docker-test.sh

    - stage: 'Deploy Preview of Docs Site'
      if: type = pull_request
      env:
        - SHA=$TRAVIS_PULL_REQUEST_SHA
      <<: *deploySite

    - stage: 'Publish to NPM'
      if: branch = master AND type = push
      install:
        - ./scripts/bin/docker-install.sh
      script:
        - echo 'This is empty for now'

    - stage: 'Publish to NPM (next)'
      if: branch = next AND type = push
      env:
        - NEXT=1
      install:
        - ./scripts/bin/docker-install.sh
      script:
        - ./scripts/bin/docker-publish.sh

    - stage: 'Deploy Production Docs Site'
      if: branch = master AND type = push
      env:
        - SHA=$TRAVIS_COMMIT
        - PROD=1
      <<: *deploySite

    - stage: 'Deploy Production Docs Site (next)'
      if: branch = next AND type = push
      env:
        - SHA=$TRAVIS_COMMIT
        - PROD=1
      <<: *deploySite
